<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>é¢¨èˆ¹å‰²ã‚Šå ã„ - Color Pop Oracle</title>
  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; margin: 0; }
    body{
      background:#070b14;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: none;
    }
    #wrap{
      position: fixed; inset: 0;
      display: grid;
      grid-template-rows: auto 1fr auto;
      padding: env(safe-area-inset-top) 10px env(safe-area-inset-bottom) 10px;
      gap: 8px;
    }
    .hud{
      display:flex; justify-content:space-between; align-items:center;
      gap:8px; flex-wrap: wrap;
      padding: 8px 6px 0;
      color:#d7e1ff;
    }
    .left{ display:flex; gap:10px; flex-wrap: wrap; }
    .pill{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 13px;
      backdrop-filter: blur(6px);
    }
    .btns{ display:flex; gap:8px; flex-wrap: wrap; }
    .btn{
      user-select:none; cursor:pointer;
      background: rgba(120,190,255,.18);
      border: 1px solid rgba(120,190,255,.35);
      color:#eaf3ff;
      padding: 9px 12px;
      border-radius: 12px;
      font-weight: 800;
      letter-spacing: .02em;
    }
    .btn:active{ transform: translateY(1px); }

    canvas{
      width: 100%;
      height: 100%;
      display:block;
      border-radius: 18px;
      background:
        radial-gradient(1200px 700px at 50% 120%, rgba(110,170,255,.16), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.10);
    }
    .foot{
      color: rgba(215,225,255,.75);
      font-size: 12px;
      padding: 0 6px 10px;
      line-height: 1.6;
      text-align: center;
    }

    /* çµæœãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal{
      position: fixed; inset: 0;
      display: none;
      place-items: center;
      padding: 18px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      z-index: 10;
    }
    .modal.show{ display: grid; }
    .card{
      width: min(560px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(12,16,28,.86);
      padding: 16px 14px 14px;
      color: rgba(235,242,255,.95);
      box-shadow: 0 20px 80px rgba(0,0,0,.55);
    }
    .headline{
      display:flex; justify-content:space-between; align-items: baseline; gap: 10px; flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .title{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .02em;
    }
    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      white-space: nowrap;
    }
    .section{
      margin-top: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 10px;
    }
    .k{ opacity: .75; font-size: 12px; }
    .v{ font-size: 14px; line-height: 1.7; margin-top: 4px; }
    .quote{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-weight: 800;
      letter-spacing: .01em;
    }
    .row{
      display:flex; gap: 8px; flex-wrap: wrap;
      margin-top: 12px;
    }
    .btn2{
      user-select:none; cursor:pointer;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(235,242,255,.95);
      flex: 1;
      min-width: 140px;
    }
    .btn2:active{ transform: translateY(1px); }
    .small{
      opacity: .7; font-size: 12px; margin-top: 10px; line-height: 1.6;
    }
  </style>
</head>
<body>
  <div id="wrap">
    <div class="hud">
      <div class="left">
        <div class="pill">SCORE: <span id="score">0</span></div>
        <div class="pill">COMBO: <span id="combo">0</span></div>
        <div class="pill">POPS: <span id="pops">0</span>/10</div>
        <div class="pill">TIME: <span id="time">30.0</span>s</div>
        <div class="pill">BEST: <span id="best">0</span></div>
      </div>
      <div class="btns">
        <button class="btn" id="btnStart">START</button>
        <button class="btn" id="btnRestart">RESTART</button>
      </div>
    </div>

    <canvas id="game"></canvas>

    <div class="foot">
      éŠã³æ–¹ï¼šé¢¨èˆ¹ã‚’ã‚¿ãƒƒãƒ—ã§å‰²ã‚‹ã ã‘ï¼ˆ10å€‹å‰²ã‚‹ã‹30ç§’ã§çµæœãŒå‡ºã‚‹ï¼‰ã€‚<br>
      PCã§ã‚‚OKï¼šã‚¯ãƒªãƒƒã‚¯ / Spaceã§é–‹å§‹ãƒ»ä¸€æ™‚åœæ­¢
    </div>
  </div>

  <!-- çµæœè¡¨ç¤º -->
  <div class="modal" id="modal">
    <div class="card">
      <div class="headline">
        <div class="title" id="r_title">ã‚ãªãŸã®ä»Šã®ã‚¿ã‚¤ãƒ—</div>
        <div class="badge" id="r_badge">â€”</div>
      </div>

      <div class="section">
        <div class="k">ã‚¿ã‚¤ãƒ—</div>
        <div class="v" id="r_type">â€”</div>
      </div>

      <div class="section">
        <div class="k">ã„ã¾ã®çŠ¶æ…‹</div>
        <div class="v" id="r_state">â€”</div>
      </div>

      <div class="section">
        <div class="k">è¡Œå‹•ã®ã‚¯ã‚»</div>
        <div class="v" id="r_style">â€”</div>
      </div>

      <div class="quote" id="r_quote">â€”</div>

      <div class="row">
        <button class="btn2" id="btnCopy">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="btn2" id="btnAgain">ã‚‚ã†ä¸€å›</button>
      </div>

      <div class="small" id="r_small">
        â€» å ã„ã¯ã€Œç›´æ„Ÿã®é¸æŠã€ã‚’ã‚‚ã¨ã«ã—ãŸéŠã³ã®è¨ºæ–­ã ã‚ˆã€‚æ°—æ¥½ã«ã©ã†ãã€‚
      </div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d", { alpha: true });

  const $score = document.getElementById("score");
  const $combo = document.getElementById("combo");
  const $time  = document.getElementById("time");
  const $best  = document.getElementById("best");
  const $pops  = document.getElementById("pops");
  const btnStart = document.getElementById("btnStart");
  const btnRestart = document.getElementById("btnRestart");

  const modal = document.getElementById("modal");
  const rTitle = document.getElementById("r_title");
  const rBadge = document.getElementById("r_badge");
  const rType  = document.getElementById("r_type");
  const rState = document.getElementById("r_state");
  const rStyle = document.getElementById("r_style");
  const rQuote = document.getElementById("r_quote");
  const rSmall = document.getElementById("r_small");
  const btnCopy = document.getElementById("btnCopy");
  const btnAgain = document.getElementById("btnAgain");

  // --- ç”»é¢ãƒ•ã‚£ãƒƒãƒˆï¼ˆé«˜DPIï¼‰ ---
  function resize(){
    const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0); // åº§æ¨™ã¯CSSãƒ”ã‚¯ã‚»ãƒ«åŸºæº–
  }
  window.addEventListener("resize", resize);

  // ---- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ----
  let W = 0, H = 0;
  let running = false;
  let finished = false;

  let score = 0;
  let combo = 0;
  let timeLeft = 30.0;

  const targetPops = 10;

  // å ã„ç”¨ãƒ­ã‚°ï¼ˆå‰²ã£ãŸãƒ‡ãƒ¼ã‚¿ï¼‰
  const popLog = []; // {t, colorKey, x,y}
  let startAt = 0;

  // BESTï¼ˆç«¯æœ«å†…ï¼‰
  const bestKey = "balloon_oracle_best_v1";
  let best = Number(localStorage.getItem(bestKey) || 0);
  $best.textContent = String(best);

  // ãƒãƒ–ãƒ« & ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
  const bubbles = [];
  const pops = [];

  // ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆã‚­ãƒ¼ä»˜ãï¼‰
  const palette = [
    { key:"RED",  hex:"#ff4d6d", name:"ç´…" },
    { key:"YEL",  hex:"#ffb703", name:"é»„" },
    { key:"BLU",  hex:"#4cc9f0", name:"é’" },
    { key:"GRN",  hex:"#8aff7a", name:"ç·‘" },
    { key:"PUR",  hex:"#b517ff", name:"ç´«" },
    { key:"PNK",  hex:"#f72585", name:"æ¡ƒ" },
    { key:"CYN",  hex:"#00f5d4", name:"ç¢§" },
    { key:"LAV",  hex:"#ffd6ff", name:"éœ" },
  ];

  function rand(a,b){ return a + Math.random()*(b-a); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function syncHUD(){
    $score.textContent = String(score);
    $combo.textContent = String(combo);
    $time.textContent = timeLeft.toFixed(1);
    $pops.textContent = `${popLog.length}/${targetPops}`;
    $best.textContent = String(best);
  }

  function reset(){
    running = false;
    finished = false;
    score = 0;
    combo = 0;
    timeLeft = 30.0;
    bubbles.length = 0;
    pops.length = 0;
    popLog.length = 0;
    startAt = 0;
    hideResult();
    syncHUD();
  }

  // ---- ãƒãƒ–ãƒ«ç”Ÿæˆ ----
  let spawnTimer = 0;
  function spawnBubble(){
    const minDim = Math.min(W,H);
    const r = rand(minDim*0.055, minDim*0.095);
    const x = rand(r+10, W-r-10);
    const y = rand(r+10, H-r-10);

    const life = rand(1.1, 1.7); // ç§’
    const grow = rand(0.85, 1.35);
    const drift = { x: rand(-20, 20), y: rand(-16, 16) };

    const p = palette[Math.floor(Math.random()*palette.length)];

    bubbles.push({
      x, y, r,
      t: 0,
      life,
      grow,
      drift,
      color: p.hex,
      colorKey: p.key,
      ring: rand(0.12, 0.22)
    });
  }

  function makePop(x,y,color,baseR){
    const count = 14 + Math.floor(Math.random()*10);
    for (let i=0; i<count; i++){
      const a = Math.random()*Math.PI*2;
      const sp = rand(120, 340);
      pops.push({
        x,y,
        vx: Math.cos(a)*sp,
        vy: Math.sin(a)*sp,
        r: rand(2, 5),
        life: rand(0.35, 0.7),
        t: 0,
        color
      });
    }
    pops.push({ x,y, vx:0, vy:0, r: baseR*0.55, life: 0.45, t:0, color, ring: true });
  }

  function toggle(){
    if (finished) return;
    running = !running;
    if (running && startAt === 0) startAt = performance.now();
  }

  btnStart.addEventListener("click", () => { if (!finished) { running = true; if (!startAt) startAt = performance.now(); } });
  btnRestart.addEventListener("click", () => reset());

  window.addEventListener("keydown", (e) => {
    if (e.key === " ") { e.preventDefault(); toggle(); }
  }, { passive:false });

  // ---- ã‚¿ãƒƒãƒ—åˆ¤å®š ----
  function getPointerPos(e){
    const rect = canvas.getBoundingClientRect();
    return { x: (e.clientX - rect.left), y: (e.clientY - rect.top) };
  }

  function tryHit(x,y){
    for (let i=bubbles.length-1; i>=0; i--){
      const b = bubbles[i];
      const dx = x - b.x, dy = y - b.y;
      if (dx*dx + dy*dy <= (b.r*b.r)){
        bubbles.splice(i,1);

        // ãƒ­ã‚°è¨˜éŒ²
        const now = performance.now();
        popLog.push({
          t: startAt ? (now - startAt)/1000 : 0,
          colorKey: b.colorKey,
          x: b.x / Math.max(1,W),
          y: b.y / Math.max(1,H),
        });

        combo += 1;
        const base = 10;
        const bonus = Math.floor(base * (1 + Math.min(8, combo)*0.25));
        score += bonus;
        makePop(b.x, b.y, b.color, b.r);

        // ã¡ã‚‡ã„æ™‚é–“å›å¾©ï¼ˆæ°—æŒã¡ã‚ˆã•ï¼‰
        timeLeft = clamp(timeLeft + 0.12, 0, 60);

        if (score > best){
          best = score;
          localStorage.setItem(bestKey, String(best));
        }

        syncHUD();

        // 10å€‹å‰²ã£ãŸã‚‰çµæœã¸
        if (popLog.length >= targetPops){
          finishAndShow();
        }
        return true;
      }
    }

    combo = 0;
    syncHUD();
    return false;
  }

  canvas.addEventListener("pointerdown", (e) => {
    canvas.setPointerCapture?.(e.pointerId);
    if (!running && !finished) { running = true; if (!startAt) startAt = performance.now(); }
    const p = getPointerPos(e);
    tryHit(p.x, p.y);
  });

  // ---- å ã„ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆâ‘¡ï¼‰ ----
  const colorMeta = {
    RED: { name:"ç´…", type:"ç«ã®æ°—", base:"å‹¢ã„ãƒ»çªç ´ãƒ»æ±ºæ–­", vibe:"èƒŒä¸­ã‚’æŠ¼ã™åŠ›ãŒå¼·ã„", quote:["è¿·ã£ãŸã‚‰å…ˆã«ä¸€æ­©ã€‚","é æ…®ã‚ˆã‚Šè¡Œå‹•ã€‚"] },
    BLU: { name:"é’", type:"æ°´ã®æ°—", base:"å†·é™ãƒ»è¦³å¯Ÿãƒ»æ•´ç†", vibe:"æƒ…å ±ã‚’æ•´ãˆã‚‹åŠ›ãŒå¼·ã„", quote:["ç­”ãˆã¯é™ã‘ã•ã®ä¸­ã€‚","ä»Šã¯æ•´ãˆã‚‹æ™‚ã€‚"] },
    GRN: { name:"ç·‘", type:"æœ¨ã®æ°—", base:"èª¿å’Œãƒ»å›å¾©ãƒ»è‚²æˆ", vibe:"å®‰å¿ƒã‚’ä½œã‚‹åŠ›ãŒå¼·ã„", quote:["ç„¦ã‚‰ãšè‚²ã¦ã‚‹ã€‚","ç¶šã‘ãŸäººãŒå‹ã¤ã€‚"] },
    YEL: { name:"é»„", type:"é¢¨ã®æ°—", base:"å¥½å¥‡å¿ƒãƒ»éŠã³ãƒ»ç™ºè¦‹", vibe:"å ´ã‚’æ˜ã‚‹ãã™ã‚‹åŠ›ãŒå¼·ã„", quote:["é¢ç™½ã„æ–¹ã¸ã€‚","è»½ã‚„ã‹ã«è©¦ã™ã€‚"] },
    PUR: { name:"ç´«", type:"æ˜Ÿã®æ°—", base:"ç›´æ„Ÿãƒ»ç¾æ„è­˜ãƒ»ã²ã‚‰ã‚ã", vibe:"è¦‹ãˆãªã„æµã‚Œã‚’èª­ã‚€", quote:["ç›´æ„Ÿã¯ã ã„ãŸã„æ­£ã—ã„ã€‚","æµ®ã‹ã‚“ã æ¡ˆã‚’æ‹¾ã†ã€‚"] },
    PNK: { name:"æ¡ƒ", type:"èŠ±ã®æ°—", base:"å…±æ„Ÿãƒ»é­…åŠ›ãƒ»é–¢ä¿‚æ€§", vibe:"äººã‚’ã‚ãŸãŸã‚ã‚‹", quote:["è¨€è‘‰ãŒé‹ã‚’é‹ã¶ã€‚","å„ªã—ã•ã¯æ­¦å™¨ã€‚"] },
    CYN: { name:"ç¢§", type:"ç©ºã®æ°—", base:"è‡ªç”±ãƒ»åˆ·æ–°ãƒ»é–‹æ”¾", vibe:"æ ã‚’å¤–ã™ã®ãŒå¾—æ„", quote:["å›ºå®šè¦³å¿µã‚’å£Šã™ã€‚","åºƒã„æ–¹ã¸ã€‚"] },
    LAV: { name:"éœ", type:"æœˆã®æ°—", base:"æ„Ÿå—æ€§ãƒ»ä½™éŸ»ãƒ»ç‰©èª", vibe:"ç©ºæ°—ã®æ©Ÿå¾®ã«å¼·ã„", quote:["ä½™ç™½ã«ç­”ãˆãŒã‚ã‚‹ã€‚","æ€¥ãŒãªã„é¸æŠã‚‚æ­£è§£ã€‚"] },
  };

  function analyze(log){
    // è‰²ã‚«ã‚¦ãƒ³ãƒˆ
    const cnt = {};
    for (const p of log) cnt[p.colorKey] = (cnt[p.colorKey]||0) + 1;

    // ãƒ¡ã‚¤ãƒ³è‰²
    let mainKey = "BLU";
    let mainN = -1;
    for (const k of Object.keys(cnt)){
      if (cnt[k] > mainN){ mainN = cnt[k]; mainKey = k; }
    }

    // ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ˆå¹³å‡é–“éš”ï¼‰
    const times = log.map(x => x.t).sort((a,b)=>a-b);
    let avgGap = 0;
    if (times.length >= 2){
      let s = 0;
      for (let i=1;i<times.length;i++) s += (times[i]-times[i-1]);
      avgGap = s / (times.length - 1);
    } else {
      avgGap = 999;
    }

    // è¿·ã„åº¦ï¼ˆé–“éš”ã®ãƒãƒ©ã¤ãï¼‰
    let varGap = 0;
    if (times.length >= 3){
      const gaps = [];
      for (let i=1;i<times.length;i++) gaps.push(times[i]-times[i-1]);
      const m = gaps.reduce((a,b)=>a+b,0)/gaps.length;
      varGap = gaps.reduce((a,g)=>a+(g-m)*(g-m),0)/gaps.length;
    }

    // è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç«¯/ä¸­å¿ƒå‚¾å‘ï¼‰
    // x,yãŒ0..1ï¼ˆä¸­å¤®ã»ã©0.5ï¼‰
    const edgeScore = log.reduce((a,p)=>{
      const dx = Math.abs(p.x - 0.5);
      const dy = Math.abs(p.y - 0.5);
      return a + (dx + dy);
    },0) / Math.max(1,log.length);
    // 0.0ï½1.0ãã‚‰ã„ï¼šå¤§ãã„ã»ã©ç«¯å¯„ã‚Š

    return { cnt, mainKey, avgGap, varGap, edgeScore };
  }

  // æ–‡ç« ï¼ˆâ‘ ï¼‰ã‚’ç”Ÿæˆ
  function buildFortune(log){
    const a = analyze(log);
    const meta = colorMeta[a.mainKey] || colorMeta.BLU;

    // çŠ¶æ…‹ï¼ˆé€Ÿã•ï¼‰
    let state = "";
    let badge = "";
    if (a.avgGap <= 0.55){
      badge = "å³æ–­ãƒ¢ãƒ¼ãƒ‰";
      state = "ä»Šã®ã‚ãªãŸã¯åå¿œãŒé€Ÿã„ã€‚ãƒãƒ£ãƒ³ã‚¹ã«é£›ã³ä¹—ã‚Œã‚‹åé¢ã€æƒ…å ±ãŒè¿½ã„ã¤ã‹ãªã„ã¾ã¾èµ°ã‚ŠãŒã¡ã€‚ä»Šæ—¥ã¯ã€Œå°ã•ãè©¦ã™â†’è‰¯ã‹ã£ãŸã‚‰ä¼¸ã°ã™ã€ãŒæœ€å¼·ã€‚";
    } else if (a.avgGap <= 0.95){
      badge = "å®‰å®šãƒ¢ãƒ¼ãƒ‰";
      state = "ãƒ†ãƒ³ãƒãŒå®‰å®šã—ã¦ã‚‹ã€‚ç„¦ã‚Šã‚‚è¿·ã„ã‚‚å°‘ãªãã€ç¾å®Ÿã«å¼·ã„çŠ¶æ…‹ã€‚ä»Šæ—¥æ±ºã‚ãŸã“ã¨ã¯ã€ãã®ã¾ã¾ç©ã¿ä¸ŠãŒã‚‹ã€‚";
    } else {
      badge = "ç†Ÿè€ƒãƒ¢ãƒ¼ãƒ‰";
      state = "æ…é‡ã•ãŒå‡ºã¦ã‚‹ã€‚æ‚ªã„å…†å€™ã˜ã‚ƒãªãã¦ã€ã„ã¾ã¯ã€Œè¦‹æ¥µã‚ã€ãŒå¿…è¦ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚æ€¥ã„ã§æ±ºã‚ã‚‹ã‚ˆã‚Šã€æ¡ä»¶ã‚’æ•´ãˆã‚‹ã»ã©å‹ç‡ãŒä¸ŠãŒã‚‹ã€‚";
    }

    // è¡Œå‹•ã®ã‚¯ã‚»ï¼ˆç«¯å¯„ã‚Šï¼‰
    let style = "";
    if (a.edgeScore >= 0.62){
      style = "ç«¯ã‚„å¤–å´ã‚’ç‹™ã†å‚¾å‘ãŒå¼·ã„ã€‚ã‚ãªãŸã¯â€œå®‰å…¨åœâ€ã§ã¯ãªãâ€œä½™ç™½â€ã«ç­”ãˆã‚’æ¢ã™äººã€‚èª°ã‚‚è¦‹ã¦ãªã„é¸æŠè‚¢ã«ãƒãƒ£ãƒ³ã‚¹ãŒè»¢ãŒã‚Šã‚„ã™ã„ã€‚";
    } else if (a.edgeScore >= 0.48){
      style = "å…¨ä½“ã‚’è¦‹ã¦ã‹ã‚‰æ‰‹ã‚’å‡ºã™ã‚¿ã‚¤ãƒ—ã€‚æ¥µç«¯ã«åã‚‰ãšã€å ´ã®æµã‚Œã‚’èª­ã‚ã‚‹ã€‚ä»Šæ—¥ã¯ã€Œæ‰‹å …ã„ä¸€æ‰‹ã€ã‚’å…ˆã«ç½®ãã¨é‹ãŒä¼¸ã³ã‚‹ã€‚";
    } else {
      style = "ä¸­å¿ƒã‹ã‚‰æ±ºã‚ã‚‹ç¾å®Ÿæ´¾ã€‚ã¾ãšâ€œä»Šã‚ã‚‹å¼·ã¿â€ã‚’ä½¿ã†ã®ãŒå¾—æ„ã€‚é å›ã‚Šã›ãšæœ€çŸ­ã§é€²ã‚ã‚‹æ—¥ã€‚";
    }

    // ã‚¿ã‚¤ãƒ—æ–‡ï¼ˆè‰²ï¼‰
    const typeText =
      `ã€${meta.name}ã®${meta.type}ã‚¿ã‚¤ãƒ—ã€‘\n` +
      `ã‚ãªãŸã®æ ¸ã¯ã€Œ${meta.base}ã€ã€‚${meta.vibe}ã€‚\n` +
      `ä»Šæ—¥ã¯â€œ${meta.name}â€ãŒå¤šã‹ã£ãŸåˆ†ã€ç›´æ„ŸãŒã‚ˆãåƒãã€‚`;

    // è‰²ã®å†…è¨³ï¼ˆçŸ­ãï¼‰
    const topColors = Object.entries(a.cnt).sort((x,y)=>y[1]-x[1]).slice(0,3)
      .map(([k,n]) => `${(colorMeta[k]?.name || k)}Ã—${n}`).join(" / ");

    // ã²ã¨ã“ã¨ï¼ˆå¼•ç”¨ï¼‰
    const q = meta.quote[Math.floor(Math.random()*meta.quote.length)];
    const quote = `ä»Šæ—¥ã®ã²ã¨ã“ã¨ï¼šã€Œ${q}ã€`;

    // å…±æœ‰ç”¨
    const share =
`é¢¨èˆ¹å‰²ã‚Šå ã„çµæœ
${meta.name}ã®${meta.type}ã‚¿ã‚¤ãƒ—ï¼ˆ${badge}ï¼‰
è‰²å†…è¨³ï¼š${topColors}
ã²ã¨ã“ã¨ï¼š${q}`;

    return { badge, typeText, state, style, quote, share };
  }

  function finishAndShow(){
    running = false;
    finished = true;
    const f = buildFortune(popLog);
    showResult(f);
  }

  // ---- çµæœè¡¨ç¤º ----
  function showResult(f){
    rTitle.textContent = "ã‚ãªãŸã®ä»Šã®ã‚¿ã‚¤ãƒ—";
    rBadge.textContent = f.badge;
    rType.textContent  = f.typeText;
    rState.textContent = f.state;
    rStyle.textContent = f.style;
    rQuote.textContent = f.quote;

    rSmall.textContent =
      `å‰²ã£ãŸå›æ•°ï¼š${popLog.length} / å¹³å‡ãƒ†ãƒ³ãƒï¼š${calcTempo(popLog)} / SCOREï¼š${score}\n` +
      `â€» å ã„ã¯ã€Œç›´æ„Ÿã®é¸æŠã€ã‚’ã‚‚ã¨ã«ã—ãŸéŠã³ã®è¨ºæ–­ã ã‚ˆã€‚æ°—æ¥½ã«ã©ã†ãã€‚`;

    modal.classList.add("show");

    // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
    btnCopy.onclick = async () => {
      const text = f.share + `\n` + location.href;
      try{
        await navigator.clipboard.writeText(text);
        btnCopy.textContent = "ã‚³ãƒ”ãƒ¼ã—ãŸï¼";
        setTimeout(()=>btnCopy.textContent="çµæœã‚’ã‚³ãƒ”ãƒ¼", 1200);
      }catch{
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ä¸å¯ç’°å¢ƒå‘ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        prompt("ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ã£ã¦ã­ğŸ‘‡", text);
      }
    };

    btnAgain.onclick = () => reset();
  }

  function hideResult(){
    modal.classList.remove("show");
    btnCopy.textContent = "çµæœã‚’ã‚³ãƒ”ãƒ¼";
  }

  function calcTempo(log){
    const times = log.map(x=>x.t).sort((a,b)=>a-b);
    if (times.length < 2) return "â€”";
    let s=0;
    for (let i=1;i<times.length;i++) s += (times[i]-times[i-1]);
    const avg = s/(times.length-1);
    return `${avg.toFixed(2)}s/å›`;
  }

  // ---- æ›´æ–° & æç”» ----
  let last = performance.now();

  function tick(now){
    const dt = Math.min(0.033, (now-last)/1000);
    last = now;

    const rect = canvas.getBoundingClientRect();
    W = rect.width; H = rect.height;

    update(dt);
    draw();
    requestAnimationFrame(tick);
  }

  function update(dt){
    if (!running || finished) return;

    timeLeft -= dt;
    if (timeLeft <= 0){
      timeLeft = 0;
      $time.textContent = timeLeft.toFixed(1);
      finishAndShow();
      return;
    }
    $time.textContent = timeLeft.toFixed(1);

    // ç”Ÿæˆãƒ†ãƒ³ãƒï¼ˆå¾ŒåŠå°‘ã—å¢—ãˆã‚‹ï¼‰
    const difficulty = 1 + (30 - timeLeft) / 30;
    const interval = clamp(0.34 / difficulty, 0.14, 0.34);

    spawnTimer += dt;
    while (spawnTimer >= interval){
      spawnTimer -= interval;
      spawnBubble();
      if (bubbles.length > 22) bubbles.shift();
    }

    // ãƒãƒ–ãƒ«æ›´æ–°
    for (let i=bubbles.length-1; i>=0; i--){
      const b = bubbles[i];
      b.t += dt;

      b.x += b.drift.x * dt;
      b.y += b.drift.y * dt;

      if (b.x - b.r < 8 || b.x + b.r > W - 8) b.drift.x *= -1;
      if (b.y - b.r < 8 || b.y + b.r > H - 8) b.drift.y *= -1;

      b.r *= (1 + dt * 0.18 * b.grow);

      // å¯¿å‘½åˆ‡ã‚Œã§ã‚³ãƒ³ãƒœçµ‚äº†ï¼ˆæ‚”ã—ã•ï¼‰
      if (b.t >= b.life){
        bubbles.splice(i,1);
        combo = 0;
        syncHUD();
      }
    }

    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
    for (let i=pops.length-1; i>=0; i--){
      const p = pops[i];
      p.t += dt;
      if (p.t >= p.life){ pops.splice(i,1); continue; }
      if (!p.ring){
        p.vy += 520 * dt;
        p.x += p.vx * dt;
        p.y += p.vy * dt;
        p.vx *= (1 - dt*2.2);
        p.vy *= (1 - dt*1.6);
      } else {
        p.r *= (1 + dt*2.0);
      }
    }
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // æ˜Ÿ
    ctx.globalAlpha = 0.22;
    for (let i=0;i<80;i++){
      const x = (i*97) % W;
      const y = (i*173) % H;
      ctx.fillStyle = "white";
      ctx.fillRect(x,y,1,1);
    }
    ctx.globalAlpha = 1;

    // ãƒãƒ–ãƒ«
    for (const b of bubbles){
      const life01 = clamp(1 - (b.t / b.life), 0, 1);

      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r*1.08, 0, Math.PI*2);
      ctx.fillStyle = "rgba(0,0,0,.25)";
      ctx.fill();

      const grad = ctx.createRadialGradient(b.x - b.r*0.35, b.y - b.r*0.35, b.r*0.2, b.x, b.y, b.r);
      grad.addColorStop(0, "rgba(255,255,255,.75)");
      grad.addColorStop(0.25, b.color + "CC");
      grad.addColorStop(1, b.color + "55");

      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
      ctx.fillStyle = grad;
      ctx.fill();

      ctx.lineWidth = Math.max(2, b.r*b.ring);
      ctx.strokeStyle = "rgba(255,255,255,.55)";
      ctx.globalAlpha = 0.35 + 0.45*life01;
      ctx.stroke();
      ctx.globalAlpha = 1;

      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r*0.88, -Math.PI/2, -Math.PI/2 + Math.PI*2*life01);
      ctx.lineWidth = 3;
      ctx.strokeStyle = "rgba(255,255,255,.35)";
      ctx.stroke();
    }

    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
    for (const p of pops){
      const a = 1 - (p.t / p.life);
      if (p.ring){
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.lineWidth = 4;
        ctx.strokeStyle = hexToRgba(p.color, 0.55*a);
        ctx.stroke();
        continue;
      }
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fillStyle = hexToRgba(p.color, 0.9*a);
      ctx.fill();
    }

    if (!running && !finished && popLog.length === 0){
      centerText("é¢¨èˆ¹ã‚’å‰²ã£ã¦å ã„é–‹å§‹", H*0.53, 18, "rgba(215,225,255,.92)");
      centerText("10å€‹å‰²ã‚‹ã‹ã€30ç§’ã§çµæœãŒå‡ºã‚‹", H*0.61, 13, "rgba(215,225,255,.72)");
    }
  }

  function centerText(text, y, size, color){
    ctx.fillStyle = color;
    ctx.font = `900 ${size}px system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, W/2, y);
  }
  function hexToRgba(hex, a){
    const h = hex.replace("#","");
    const r = parseInt(h.slice(0,2),16);
    const g = parseInt(h.slice(2,4),16);
    const b = parseInt(h.slice(4,6),16);
    return `rgba(${r},${g},${b},${a})`;
  }

  // åˆæœŸåŒ–
  requestAnimationFrame(() => {
    resize();
    reset();
    requestAnimationFrame(tick);
  });
})();
</script>
</body>
</html>